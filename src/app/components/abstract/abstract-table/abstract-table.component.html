@let _displayedColumns = displayedColumns();
@let _displayedDetailColumns = displayedDetailColumns();
@let _columns = columns();
@let _expandable = expandable();
@let _expandableTemplateRef = expandableTemplateRef();

<div class="mat-elevation-z8 position-relative">
  @if (isLoadingResults) {
    <div class="loading-shade">
      <mat-spinner></mat-spinner>
    </div>
  }

  <ng-container [formGroup]="filterForm">
    <div class="table-container">
      <table
        [style.--col-count]="_columns.length"
        mat-table
        [ngClass]="{
          expandable: _expandable,
          'equal-cols': equalize,
        }"
        [dataSource]="contentArray"
        multiTemplateDataRows
        [trackBy]="trackBy"
        matSort>
        @for (column of _columns; track column) {
          <ng-container [matColumnDef]="column.alias">
            <th mat-header-cell *matHeaderCellDef>
              <span mat-sort-header>{{ column.label }}</span>
              <ng-container
                [ngTemplateOutlet]="headerFilter"
                [ngTemplateOutletContext]="{ column }"></ng-container>
            </th>
            <td mat-cell *matCellDef="let row" [class]="column.className">
              <ng-container
                [ngTemplateOutlet]="td"
                [ngTemplateOutletContext]="{ column, element: row }" />
            </td>
          </ng-container>
        }

        @if (_expandable) {
          @if (_expandableTemplateRef) {
            <ng-container matColumnDef="expandedDetail">
              <td mat-cell *matCellDef="let element" [attr.colspan]="_columns.length">
                <div class="detail-wrapper" [class.detail-wrapper-expanded]="isExpanded(element)">
                  <div class="detail">
                    <ng-container
                      [ngTemplateOutlet]="_expandableTemplateRef"
                      [ngTemplateOutletContext]="{ element }" />
                  </div>
                </div>
              </td>
            </ng-container>
          } @else {
            @for (column of _columns; track column) {
              <ng-container [matColumnDef]="column.alias + '__detail'">
                <td
                  mat-cell
                  *matCellDef="let element"
                  class="detail-cell"
                  [class]="column.className">
                  <ng-container
                    [ngTemplateOutlet]="td"
                    [ngTemplateOutletContext]="{ column, element }" />
                </td>
              </ng-container>
            }
          }
        }

        <!-- Header -->
        <tr mat-header-row *matHeaderRowDef="_displayedColumns; sticky: true"></tr>

        <!-- Rows -->
        <tr
          mat-row
          *matRowDef="let row; columns: _displayedColumns"
          class="table-row"
          [class.expanded-row]="isExpanded(row)"
          (click)="_expandable && toggle(row)"></tr>

        @if (_expandable) {
          <!-- Expand row -->
          @if (_expandableTemplateRef) {
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
          } @else {
            <tr
              mat-row
              *matRowDef="let row; columns: _displayedDetailColumns; when: rowIsExpanded"></tr>
          }
        }

        <tr class="mat-row no-data" *matNoDataRow>
          <td class="mat-cell color-white text-center" [colSpan]="_displayedColumns.length">
            {{ isLoadingResults ? 'Loading table data. Please wait.' : 'No data available' }}
          </td>
        </tr>
      </table>
    </div>

    <mat-paginator
      [length]="totalElements"
      [pageSize]="itemsPerPage"
      (page)="pageChanged($event)"
      [pageSizeOptions]="[5, 10, 25, 100]"
      aria-label="Select page">
    </mat-paginator>

    <button mat-stroked-button (click)="equalize = !equalize">
      {{ equalize ? 'Снять одинаковые ширины' : 'Равные ширины колонок' }}
    </button>

    <ng-template #td let-column="column" let-element="element">
      @let rowValue = element[column.tdAlias || column.alias];
      {{ column.tdParser ? column.tdParser(element) : rowValue }}
    </ng-template>

    <ng-template #headerFilter let-column="column">
      @switch (column.filter.filterType) {
        @case (filterTypes.TEXT) {
          <app-text-input [label]="column.label" [controlName]="column.alias" />
        }
        @case (filterTypes.SELECT) {
          <app-base-select
            [label]="column.label"
            [controlName]="column.alias"
            [source]="column.filter.source"
            [isMulti]="column.filter.multi ?? false" />
        }
      }
    </ng-template>
  </ng-container>
</div>
