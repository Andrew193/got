<div class="container-fluid position-relative">
  @if (autoFight) {
    <div class="position-absolute top-0 h-100 banner">
      <h3 class="text-center mt-2 fade-black-bg">
        <span class="caption">Auto fight. Please wait.</span>
      </h3>
    </div>
  }

  @if (battleMode) {
    <h4 class="text-center">
      <span class="user-bar">Turn: {{ turnUser ? 'Player' : 'AI' }}</span>
    </h4>
    <div class="heroes-bar flex-row">
      <div class="turns-counter col-2 d-flex justify-content-center cursor-pointer">
        <div class="col-9">
          <div (click)="finishTurn()">
            <span>{{ turnCount }} / {{ maxTurnCount }}</span>
          </div>
        </div>
      </div>
    </div>
  }
  <main class="flex-row justify-content-between">
    <div class="col-12">
      <app-basic-game-board
        [gameConfig]="gameConfig"
        [battleMode]="battleMode"
        (moveEntity)="moveEntity($event)"
        (highlightMakeMove)="highlightMakeMove($event)"></app-basic-game-board>
    </div>
    <aside class="col-12 d-flex flex-column mb-3">
      @if (skillsInAttackBar.length) {
        <div class="meta-aside mb-3 flex-row justify-content-evenly p-1 color-white">
          @for (skill of skillsInAttackBar; track skill.name + $index) {
            <div class="skills-container col-3">
              <div>
                <p class="text-center">{{ skill.name }}</p>
                <div class="text-center">
                  <div
                    class="position-relative"
                    style="margin: 0 auto; width: fit-content"
                    [matTooltip]="skill.description">
                    <img
                      [alt]="skill.name"
                      [src]="skill.imgSrc"
                      class="cursor-pointer me-0"
                      (click)="attack(skill)" />

                    @if (skill.remainingCooldown || skill.passive) {
                      <div class="skill-disabled" style="top: 0px; left: 0px">
                        <i aria-hidden="true">{{
                          skill.passive ? 'P' : skill.remainingCooldown
                        }}</i>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }
      <div class="meta-aside">
        <mat-tab-group>
          <mat-tab>
            <ng-template mat-tab-label>
              {{ battleMode ? 'My heroes' : 'Rangers' }}
            </ng-template>
            <ng-container
              [ngTemplateOutlet]="asideUnits"
              [ngTemplateOutletContext]="{
                units: userUnits,
              }"></ng-container>
          </mat-tab>
          <mat-tab>
            <ng-template mat-tab-label>
              {{ battleMode ? 'Enemies' : 'Loot' }}
            </ng-template>
            <ng-container
              [ngTemplateOutlet]="asideUnits"
              [ngTemplateOutletContext]="{
                units: aiUnits,
              }"></ng-container>
          </mat-tab>
          <mat-tab>
            <ng-template mat-tab-label>
              {{ battleMode ? 'Battle history' : 'History' }}
            </ng-template>
            <div class="heroes user-heroes m-1 row g-0 gap-2">
              <cdk-virtual-scroll-viewport itemSize="70" class="example-viewport">
                <div *cdkVirtualFor="let logRecord of log">
                  @if (logRecord.message) {
                    <p
                      class="log-record"
                      [ngClass]="{
                        'red-b': logRecord.isUser,
                        'green-b': !logRecord.isUser,
                        'entity-b': logRecord.info,
                      }">
                      <img [src]="logRecord.imgSrc" alt="Effect img" />
                      <span>{{ logRecord.message }}</span>
                    </p>
                  }
                </div>
              </cdk-virtual-scroll-viewport>
            </div>
          </mat-tab>
        </mat-tab-group>
      </div>
    </aside>
  </main>
  <div class="d-flex actions">
    @if (!autoFight) {
      <button class="got-toggle got-toggle-green" (click)="startAutoFight(false)">Auto Play</button>
      <button class="ms-1 got-toggle got-toggle-green" (click)="startAutoFight(false, true)">
        Skip one turn
      </button>
    }
    <ng-content select="bottom-navigation"></ng-content>
  </div>
</div>

<ng-template #asideUnits let-units="units">
  <div class="heroes user-heroes m-1 row g-0 gap-2">
    @for (hero of units; track hero.name + hero.x + hero.y) {
      <mat-expansion-panel hideToggle>
        <mat-expansion-panel-header>
          <div class="flex-column d-flex w-100 p-1 shadow-none">
            <div class="row m-0 gap-2">
              <div class="col-auto p-0">
                <div class="position-relative m-0-auto" style="width: fit-content">
                  @let showMode = shouldRenderAction(hero, 'canMove');
                  @let showAttack = shouldRenderAction(hero, 'canAttack');

                  <img
                    [src]="hero.imgSrc"
                    [alt]="hero.name"
                    class="game-field-img"
                    [ngClass]="{ disabled: !hero.health }" />
                  @if (showMode) {
                    <img
                      src="assets/resourses/imgs/icons/move_icon.png"
                      alt="can move"
                      class="action-icon position-absolute can-move-icon" />
                  }
                  @if (showAttack) {
                    <img
                      src="assets/resourses/imgs/icons/attack_icon.png"
                      alt="can attack"
                      class="action-icon position-absolute can-attack-icon" />
                  }
                </div>
              </div>
              <div class="col p-0">
                <div class="aside-hero-tab-header">
                  <h4 class="color-white text-center">{{ hero.name }}</h4>
                  @let showProgressBar = battleMode ? battleMode : hero.user;

                  @if (showProgressBar) {
                    <mat-progress-bar
                      class="example-margin"
                      [mode]="'determinate'"
                      [value]="(hero.health * 100) / hero.maxHealth">
                    </mat-progress-bar>
                  }
                </div>
              </div>
            </div>

            @if (battleMode ? battleMode : hero.user) {
              <div class="row m-0 gap-2 g-1 effects-container">
                @for (effect of hero.effects; track effect.type + $index) {
                  <div class="p-0 col-auto position-relative">
                    <img [src]="effect.imgSrc" [matTooltip]="effect.type" [alt]="effect.type" />
                    <span>{{ effect.duration }}</span>
                  </div>
                }
              </div>
            }
          </div>
        </mat-expansion-panel-header>
        <div>
          @let showHeroesConfig = battleMode ? battleMode : hero.user;

          @if (showHeroesConfig) {
            <div class="flex-row justify-content-between color-white">
              <div class="col-12 stats justify-content-between">
                <div class="d-flex justify-content-evenly">
                  <p>
                    <img src="assets/resourses/imgs/icons/health_icon.png" alt="health icon" />
                    <span class="d-block">{{ hero.maxHealth }}</span>
                  </p>
                  <p>
                    <img src="assets/resourses/imgs/icons/attack_icon.png" alt="attack icon" />
                    <span class="d-block">{{ hero.attack }}</span>
                  </p>
                  <p>
                    <img src="assets/resourses/imgs/icons/def_icon.png" alt="defence icon" />
                    <span class="d-block">{{ hero.defence }}</span>
                  </p>
                </div>
                <p>{{ hero.health ? 'Health: ' + hero.health : '' }}</p>
              </div>
              <div class="col-12 row" style="margin: unset">
                <div class="stats h-100 w-100 skills-bar">
                  <div class="flex-row skills-container justify-content-evenly">
                    @for (skill of hero.skills; track skill.name + $index) {
                      <div class="position-relative" [matTooltip]="skill.description">
                        <img alt="skill" [src]="skill.imgSrc" />
                        @if (skill.remainingCooldown || skill.passive) {
                          <div class="skill-disabled">
                            <i aria-hidden="true">{{
                              skill.passive ? 'P' : skill.remainingCooldown
                            }}</i>
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          } @else {
            {{ hero.description }}
          }
        </div>
      </mat-expansion-panel>
    }
  </div>
</ng-template>
